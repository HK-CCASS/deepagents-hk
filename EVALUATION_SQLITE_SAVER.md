# SqliteSaver è¿ç§»æ–¹æ¡ˆ - å¤šä¸“å®¶å…¨é¢è¯„ä¼°æŠ¥å‘Š

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

**è¯„ä¼°ç›®æ ‡**ï¼šå°† deepagents-hk é¡¹ç›®ä» `InMemorySaver` è¿ç§»åˆ° `SqliteSaver`ï¼Œå®ç°å¯¹è¯å†å²æŒä¹…åŒ–å’Œç»§ç»­å¯¹è¯åŠŸèƒ½ã€‚

**è¯„ä¼°ç»“è®º**ï¼šâœ… **å¼ºçƒˆæ¨èå®æ–½**ï¼Œä½†éœ€è¦åˆ†é˜¶æ®µæ¨è¿›ï¼Œä¼˜å…ˆå®ç°æ ¸å¿ƒåŠŸèƒ½ï¼Œåç»­ä¼˜åŒ–ç”¨æˆ·ä½“éªŒã€‚

**é£é™©ç­‰çº§**ï¼šğŸŸ¢ **ä½é£é™©** - æŠ€æœ¯æˆç†Ÿã€å½±å“å¯æ§ã€æ”¶ç›Šæ˜ç¡®

---

## 1. æŠ€æœ¯å¯è¡Œæ€§è¯„ä¼° âš™ï¸

### 1.1 ä»£ç å˜æ›´ç‚¹åˆ†æ

#### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆ3ä¸ªæ ¸å¿ƒæ–‡ä»¶ï¼‰

| æ–‡ä»¶ | è¡Œå· | å½“å‰å®ç° | å˜æ›´å†…å®¹ | å¤æ‚åº¦ |
|------|------|----------|----------|--------|
| `src/agents/main_agent.py` | 266 | `InMemorySaver()` | æ”¹ä¸º `SqliteSaver.from_conn_string()` | â­ ä½ |
| `src/cli/commands.py` | 21 | é‡ç½®ä¸º `InMemorySaver()` | æ”¹ä¸ºåˆ é™¤ thread æˆ–åˆ›å»ºæ–° thread | â­â­ ä¸­ |
| `src/cli/execution.py` | 227 | `thread_id: "main"` | ä¿æŒä¸å˜æˆ–æ”¯æŒåŠ¨æ€ thread | â­ ä½ |

#### ä»£ç å˜æ›´ç¤ºä¾‹

```python
# å˜æ›´å‰ (main_agent.py)
from langgraph.checkpoint.memory import InMemorySaver
agent.checkpointer = InMemorySaver()

# å˜æ›´å
from langgraph.checkpoint.sqlite import SqliteSaver
from pathlib import Path

agent_dir = Path.home() / ".hkex-agent" / assistant_id
db_path = agent_dir / "checkpoints.db"
checkpointer = SqliteSaver.from_conn_string(f"sqlite:///{db_path}")
agent.checkpointer = checkpointer
```

**å˜æ›´é‡è¯„ä¼°**ï¼š
- æ ¸å¿ƒä»£ç ï¼š~20 è¡Œæ–°å¢/ä¿®æ”¹
- æµ‹è¯•ä»£ç ï¼š~50 è¡Œï¼ˆæ–°å¢æµ‹è¯•ç”¨ä¾‹ï¼‰
- **æ€»å˜æ›´é‡ï¼šå°ï¼ˆ<100 è¡Œï¼‰**

### 1.2 ä¾èµ–ç®¡ç†

#### æ–°å¢ä¾èµ–

```toml
# pyproject.toml éœ€è¦æ·»åŠ 
dependencies = [
    # ... ç°æœ‰ä¾èµ– ...
    "langgraph-checkpoint-sqlite>=0.1.0",  # æ–°å¢
]
```

**ä¾èµ–å½±å“**ï¼š
- âœ… å®˜æ–¹ç»´æŠ¤ï¼Œç¨³å®šå¯é 
- âœ… è½»é‡çº§ï¼ˆ~500KBï¼‰
- âœ… æ— é¢å¤–ç³»ç»Ÿä¾èµ–ï¼ˆSQLite å†…ç½®ï¼‰
- âš ï¸ éœ€è¦æ›´æ–° `pyproject.toml` å’Œ `uv.lock`

### 1.3 å…¼å®¹æ€§åˆ†æ

| å…¼å®¹æ€§ç»´åº¦ | è¯„ä¼° | è¯´æ˜ |
|-----------|------|------|
| **LangGraph API** | âœ… å®Œå…¨å…¼å®¹ | SqliteSaver å®ç°ç›¸åŒæ¥å£ |
| **DeepAgents æ¡†æ¶** | âœ… å®Œå…¨å…¼å®¹ | æ¡†æ¶æ”¯æŒä»»æ„ Checkpointer |
| **Python ç‰ˆæœ¬** | âœ… å…¼å®¹ | æ”¯æŒ Python 3.11+ |
| **ç°æœ‰åŠŸèƒ½** | âœ… å‘åå…¼å®¹ | ä¸å½±å“ç°æœ‰åŠŸèƒ½ |
| **æ•°æ®è¿ç§»** | âœ… æ— éœ€è¿ç§» | é¦–æ¬¡è¿è¡Œè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“ |

**å…¼å®¹æ€§ç»“è®º**ï¼šâœ… **å®Œå…¨å…¼å®¹ï¼Œæ— ç ´åæ€§å˜æ›´**

---

## 2. æ€§èƒ½å½±å“è¯„ä¼° ğŸš€

### 2.1 å»¶è¿Ÿåˆ†æï¼ˆå•ç”¨æˆ·åœºæ™¯ï¼‰

| æ“ä½œç±»å‹ | InMemorySaver | SqliteSaver | å»¶è¿Ÿå¢åŠ  | ç”¨æˆ·æ„ŸçŸ¥ |
|---------|--------------|-------------|---------|---------|
| **å†™å…¥æ£€æŸ¥ç‚¹** | ~1ms | ~10-50ms | +9-49ms | âŒ ä¸å¯æ„ŸçŸ¥ |
| **è¯»å–çŠ¶æ€** | ~0.1ms | ~5-20ms | +4.9-19.9ms | âŒ ä¸å¯æ„ŸçŸ¥ |
| **å¯åŠ¨åŠ è½½** | N/A | ~20-100ms | +20-100ms | âš ï¸ è½»å¾®æ„ŸçŸ¥ |
| **å¯¹è¯ç»§ç»­** | N/A | ~10-30ms | +10-30ms | âŒ ä¸å¯æ„ŸçŸ¥ |

**æ€§èƒ½å½±å“è¯„ä¼°**ï¼š
- **å•ç”¨æˆ·åœºæ™¯**ï¼šâœ… **å½±å“å¯å¿½ç•¥**ï¼ˆ<100ms å»¶è¿Ÿï¼‰
- **å¤šç”¨æˆ·åœºæ™¯**ï¼šâš ï¸ **éœ€æ³¨æ„**ï¼ˆSQLite å¹¶å‘é”ï¼Œä½†æœ¬é¡¹ç›®ä¸ºå•ç”¨æˆ· CLIï¼‰

### 2.2 å­˜å‚¨ç©ºé—´åˆ†æ

#### å­˜å‚¨ä¼°ç®—

```
å‡è®¾åœºæ™¯ï¼š
- å¹³å‡æ¯æ¬¡å¯¹è¯ï¼š10 è½®äº¤äº’
- æ¯è½®æ¶ˆæ¯ï¼š~500 tokens
- æ£€æŸ¥ç‚¹é¢‘ç‡ï¼šæ¯è½®å¯¹è¯å

å•æ¬¡å¯¹è¯å­˜å‚¨ï¼š~5-10 KB
100 æ¬¡å¯¹è¯ï¼š~500 KB - 1 MB
1000 æ¬¡å¯¹è¯ï¼š~5-10 MB
```

**å­˜å‚¨ç»“è®º**ï¼š
- âœ… **å­˜å‚¨éœ€æ±‚å°**ï¼ˆ<10MB å…¸å‹åœºæ™¯ï¼‰
- âœ… **å¯æ¥å—**ï¼ˆç°ä»£ç£ç›˜ç©ºé—´å……è¶³ï¼‰
- âš ï¸ **éœ€è¦æ¸…ç†æœºåˆ¶**ï¼ˆé•¿æœŸè¿è¡Œï¼‰

### 2.3 å¹¶å‘æ€§èƒ½

| åœºæ™¯ | InMemorySaver | SqliteSaver | å½±å“ |
|------|--------------|-------------|------|
| **å•ç”¨æˆ· CLI** | âœ… æ— é” | âœ… å•è¿æ¥ | âœ… æ— å½±å“ |
| **API å¤šè¯·æ±‚** | âœ… å†…å­˜éš”ç¦» | âš ï¸ SQLite é” | âš ï¸ è½»å¾®å½±å“ |
| **å¹¶å‘å†™å…¥** | âœ… æ— å†²çª | âš ï¸ åºåˆ—åŒ–å†™å…¥ | âš ï¸ å¯æ¥å— |

**å¹¶å‘ç»“è®º**ï¼š
- **å½“å‰é¡¹ç›®ï¼ˆCLIï¼‰**ï¼šâœ… **æ— å½±å“**
- **æœªæ¥æ‰©å±•ï¼ˆAPIï¼‰**ï¼šâš ï¸ **éœ€è¯„ä¼°**ï¼ˆä½†å½“å‰æ— æ­¤éœ€æ±‚ï¼‰

---

## 3. ç”¨æˆ·ä½“éªŒè¯„ä¼° ğŸ‘¥

### 3.1 åŠŸèƒ½æ”¹è¿›

#### æ–°å¢åŠŸèƒ½

| åŠŸèƒ½ | å½“å‰çŠ¶æ€ | æ”¹è¿›å | ç”¨æˆ·ä»·å€¼ |
|------|---------|--------|---------|
| **å¯¹è¯å†å²æŸ¥çœ‹** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ | â­â­â­â­â­ é«˜ |
| **ç»§ç»­å¯¹è¯** | âŒ ä¸æ”¯æŒ | âœ… è‡ªåŠ¨ç»§ç»­ | â­â­â­â­â­ é«˜ |
| **è·¨ä¼šè¯è®°å¿†** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ | â­â­â­â­ ä¸­é«˜ |
| **å¯¹è¯å¯¼å‡º** | âŒ ä¸æ”¯æŒ | âœ… å¯å®ç° | â­â­â­ ä¸­ |

#### ç”¨æˆ·ä½“éªŒæå‡

**åœºæ™¯ 1ï¼šä¸­æ–­åç»§ç»­**
```
å½“å‰ï¼šç”¨æˆ·ä¸­æ–­å¯¹è¯ â†’ é‡å¯ç¨‹åº â†’ å¿˜è®°ä¹‹å‰å†…å®¹ â†’ éœ€è¦é‡æ–°è¯´æ˜
æ”¹è¿›ï¼šç”¨æˆ·ä¸­æ–­å¯¹è¯ â†’ é‡å¯ç¨‹åº â†’ è‡ªåŠ¨æ¢å¤ä¸Šä¸‹æ–‡ â†’ æ— ç¼ç»§ç»­ âœ…
```

**åœºæ™¯ 2ï¼šå†å²æŸ¥è¯¢**
```
å½“å‰ï¼šç”¨æˆ·æƒ³æŸ¥çœ‹ä¹‹å‰çš„åˆ†æç»“æœ â†’ æ— æ³•æŸ¥çœ‹ â†’ éœ€è¦é‡æ–°åˆ†æ
æ”¹è¿›ï¼šç”¨æˆ·æƒ³æŸ¥çœ‹ä¹‹å‰çš„åˆ†æç»“æœ â†’ /history å‘½ä»¤ â†’ ç«‹å³æŸ¥çœ‹ âœ…
```

**åœºæ™¯ 3ï¼šå¤šè½®åˆ†æ**
```
å½“å‰ï¼šç”¨æˆ·è¿›è¡Œå¤šè½®åˆ†æ â†’ æ¯æ¬¡é‡å¯ä¸¢å¤±ä¸Šä¸‹æ–‡ â†’ æ•ˆç‡ä½
æ”¹è¿›ï¼šç”¨æˆ·è¿›è¡Œå¤šè½®åˆ†æ â†’ ä¸Šä¸‹æ–‡è‡ªåŠ¨ä¿ç•™ â†’ æ•ˆç‡é«˜ âœ…
```

### 3.2 äº¤äº’è®¾è®¡å»ºè®®

#### æ¨èå®ç°æ–¹æ¡ˆ

**é˜¶æ®µ 1ï¼šåŸºç¡€åŠŸèƒ½ï¼ˆæ¨èå…ˆå®ç°ï¼‰**
```python
# è‡ªåŠ¨ç»§ç»­å¯¹è¯ï¼ˆæ— éœ€ç”¨æˆ·æ“ä½œï¼‰
# ä¿æŒ thread_id="main"ï¼Œè‡ªåŠ¨æ¢å¤å†å²

# æ–°å¢å‘½ä»¤
/history        # æŸ¥çœ‹å¯¹è¯å†å²
/clear          # æ¸…ç©ºå½“å‰å¯¹è¯ï¼ˆåˆ›å»ºæ–° threadï¼‰
```

**é˜¶æ®µ 2ï¼šé«˜çº§åŠŸèƒ½ï¼ˆåç»­ä¼˜åŒ–ï¼‰**
```python
# å¤šä¼šè¯æ”¯æŒ
/sessions       # åˆ—å‡ºæ‰€æœ‰ä¼šè¯
/session <id>   # åˆ‡æ¢åˆ°æŒ‡å®šä¼šè¯
/new-session    # åˆ›å»ºæ–°ä¼šè¯
/export         # å¯¼å‡ºå¯¹è¯è®°å½•
```

### 3.3 å­¦ä¹ æ›²çº¿

| ç”¨æˆ·ç±»å‹ | å­¦ä¹ æˆæœ¬ | è¯´æ˜ |
|---------|---------|------|
| **æ–°ç”¨æˆ·** | â­ ä½ | æ— éœ€å­¦ä¹ ï¼Œè‡ªåŠ¨å·¥ä½œ |
| **ç°æœ‰ç”¨æˆ·** | â­ ä½ | å‘åå…¼å®¹ï¼Œå¯é€‰ä½¿ç”¨æ–°åŠŸèƒ½ |
| **å¼€å‘è€…** | â­â­ ä¸­ | éœ€è¦äº†è§£ thread_id æ¦‚å¿µ |

**å­¦ä¹ æ›²çº¿ç»“è®º**ï¼šâœ… **ä½å­¦ä¹ æˆæœ¬ï¼Œç”¨æˆ·å‹å¥½**

---

## 4. å®ç°å¤æ‚åº¦è¯„ä¼° ğŸ”§

### 4.1 å¼€å‘å·¥ä½œé‡ä¼°ç®—

| ä»»åŠ¡ | å·¥ä½œé‡ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|--------|--------|------|
| **æ ¸å¿ƒè¿ç§»** | 2-4 å°æ—¶ | P0 | ä¿®æ”¹ checkpointer è®¾ç½® |
| **/clear å‘½ä»¤æ”¹è¿›** | 2-3 å°æ—¶ | P0 | å¤„ç† thread æ¸…ç† |
| **/history å‘½ä»¤** | 4-6 å°æ—¶ | P1 | å®ç°å†å²æŸ¥çœ‹åŠŸèƒ½ |
| **æµ‹è¯•ç”¨ä¾‹** | 3-4 å°æ—¶ | P1 | å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯• |
| **æ–‡æ¡£æ›´æ–°** | 1-2 å°æ—¶ | P2 | æ›´æ–°ä½¿ç”¨æ–‡æ¡£ |
| **æ¸…ç†æœºåˆ¶** | 2-3 å°æ—¶ | P2 | å®ç°è‡ªåŠ¨æ¸…ç†æ—§å¯¹è¯ |

**æ€»å·¥ä½œé‡**ï¼š**14-22 å°æ—¶**ï¼ˆçº¦ 2-3 ä¸ªå·¥ä½œæ—¥ï¼‰

### 4.2 æŠ€æœ¯éš¾ç‚¹

| éš¾ç‚¹ | å¤æ‚åº¦ | è§£å†³æ–¹æ¡ˆ |
|------|--------|---------|
| **/clear å‘½ä»¤å®ç°** | â­â­ ä¸­ | ä½¿ç”¨æ–° thread_id è€Œéåˆ é™¤æ•°æ® |
| **å†å²æ¶ˆæ¯æ ¼å¼åŒ–** | â­ ä½ | ä½¿ç”¨ LangGraph çš„ get_state API |
| **å¤šä¼šè¯ç®¡ç†** | â­â­â­ é«˜ | åç»­å®ç°ï¼Œå½“å‰ä¿æŒç®€å• |
| **æ•°æ®æ¸…ç†ç­–ç•¥** | â­â­ ä¸­ | åŸºäºæ—¶é—´æˆ³çš„æ¸…ç†æœºåˆ¶ |

**å¤æ‚åº¦ç»“è®º**ï¼šâœ… **æ•´ä½“å¤æ‚åº¦ä½ï¼Œå¯å¿«é€Ÿå®ç°**

### 4.3 æµ‹è¯•éœ€æ±‚

#### æµ‹è¯•ç”¨ä¾‹æ¸…å•

```python
# 1. åŸºç¡€åŠŸèƒ½æµ‹è¯•
- test_sqlite_saver_initialization()
- test_conversation_persistence()
- test_conversation_restore()
- test_clear_command()

# 2. è¾¹ç•Œæƒ…å†µæµ‹è¯•
- test_empty_conversation()
- test_large_conversation()
- test_concurrent_access()  # å¦‚æœæ”¯æŒ API

# 3. é›†æˆæµ‹è¯•
- test_cli_conversation_flow()
- test_api_conversation_flow()
```

**æµ‹è¯•å·¥ä½œé‡**ï¼š3-4 å°æ—¶

---

## 5. é£é™©è¯„ä¼° âš ï¸

### 5.1 æŠ€æœ¯é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| **SQLite æ–‡ä»¶æŸå** | ğŸŸ¡ ä½ | ğŸŸ¡ ä¸­ | å®šæœŸå¤‡ä»½ã€é”™è¯¯æ¢å¤æœºåˆ¶ |
| **æ•°æ®åº“é”å®š** | ğŸŸ¡ ä½ | ğŸŸ¢ ä½ | å•ç”¨æˆ·åœºæ™¯ï¼Œå½±å“å° |
| **æ€§èƒ½ä¸‹é™** | ğŸŸ¢ æä½ | ğŸŸ¢ ä½ | å•ç”¨æˆ·åœºæ™¯ï¼Œå»¶è¿Ÿå¯å¿½ç•¥ |
| **æ•°æ®æ³„éœ²** | ğŸŸ¡ ä½ | ğŸ”´ é«˜ | æ–‡ä»¶æƒé™æ§åˆ¶ã€åŠ å¯†å­˜å‚¨ï¼ˆå¯é€‰ï¼‰ |

**æŠ€æœ¯é£é™©ç­‰çº§**ï¼šğŸŸ¢ **ä½é£é™©**

### 5.2 æ•°æ®ç®¡ç†é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| **æ•°æ®åº“æ–‡ä»¶å¢é•¿** | ğŸŸ¢ é«˜ | ğŸŸ¡ ä¸­ | å®ç°æ¸…ç†æœºåˆ¶ã€å®šæœŸå½’æ¡£ |
| **ç£ç›˜ç©ºé—´ä¸è¶³** | ğŸŸ¡ ä½ | ğŸŸ¡ ä¸­ | ç›‘æ§ç£ç›˜ä½¿ç”¨ã€è­¦å‘Šæœºåˆ¶ |
| **æ•°æ®è¿ç§»å›°éš¾** | ğŸŸ¢ ä½ | ğŸŸ¢ ä½ | æ— éœ€è¿ç§»ï¼Œé¦–æ¬¡è¿è¡Œè‡ªåŠ¨åˆ›å»º |

**æ•°æ®ç®¡ç†é£é™©ç­‰çº§**ï¼šğŸŸ¡ **ä¸­ç­‰é£é™©ï¼Œå¯æ§**

### 5.3 å…¼å®¹æ€§é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| **API å˜æ›´** | ğŸŸ¢ æä½ | ğŸŸ¢ ä½ | ä½¿ç”¨ç¨³å®šç‰ˆæœ¬ |
| **ä¾èµ–å†²çª** | ğŸŸ¢ ä½ | ğŸŸ¢ ä½ | ç‹¬ç«‹ä¾èµ–ï¼Œæ— å†²çª |
| **ç°æœ‰åŠŸèƒ½ç ´å** | ğŸŸ¢ æä½ | ğŸ”´ é«˜ | å……åˆ†æµ‹è¯•ã€å‘åå…¼å®¹ |

**å…¼å®¹æ€§é£é™©ç­‰çº§**ï¼šğŸŸ¢ **ä½é£é™©**

### 5.4 ç”¨æˆ·å½±å“é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| **è‡ªåŠ¨åŠ è½½å†å²** | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | æä¾› /clear å‘½ä»¤ |
| **éšç§æ‹…å¿§** | ğŸŸ¡ ä½ | ğŸŸ¡ ä¸­ | æ˜ç¡®è¯´æ˜æ•°æ®å­˜å‚¨ä½ç½® |
| **å­¦ä¹ æˆæœ¬** | ğŸŸ¢ ä½ | ğŸŸ¢ ä½ | å‘åå…¼å®¹ï¼Œå¯é€‰åŠŸèƒ½ |

**ç”¨æˆ·å½±å“é£é™©ç­‰çº§**ï¼šğŸŸ¡ **ä¸­ç­‰é£é™©ï¼Œå¯æ¥å—**

---

## 6. æœ€ä½³å®è·µå»ºè®® ğŸ’¡

### 6.1 å®æ–½æ–¹æ¡ˆï¼ˆåˆ†é˜¶æ®µï¼‰

#### é˜¶æ®µ 1ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆæ¨èç«‹å³å®æ–½ï¼‰

**ç›®æ ‡**ï¼šå®ç°å¯¹è¯æŒä¹…åŒ–å’Œè‡ªåŠ¨ç»§ç»­

**å®æ–½æ­¥éª¤**ï¼š
1. âœ… ä¿®æ”¹ `main_agent.py` ä½¿ç”¨ `SqliteSaver`
2. âœ… æ”¹è¿› `/clear` å‘½ä»¤ï¼ˆä½¿ç”¨æ–° thread_idï¼‰
3. âœ… æ·»åŠ åŸºç¡€æµ‹è¯•
4. âœ… æ›´æ–°æ–‡æ¡£

**é¢„è®¡æ—¶é—´**ï¼š1-2 å¤©

#### é˜¶æ®µ 2ï¼šå†å²æŸ¥çœ‹ï¼ˆåç»­ä¼˜åŒ–ï¼‰

**ç›®æ ‡**ï¼šæ·»åŠ  `/history` å‘½ä»¤

**å®æ–½æ­¥éª¤**ï¼š
1. å®ç°å†å²æ¶ˆæ¯è¯»å–
2. æ ¼å¼åŒ–æ˜¾ç¤º
3. æ·»åŠ åˆ†é¡µæ”¯æŒï¼ˆå¦‚æœå†å²å¾ˆé•¿ï¼‰

**é¢„è®¡æ—¶é—´**ï¼š1 å¤©

#### é˜¶æ®µ 3ï¼šé«˜çº§åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

**ç›®æ ‡**ï¼šå¤šä¼šè¯ç®¡ç†ã€å¯¼å‡ºåŠŸèƒ½

**å®æ–½æ­¥éª¤**ï¼š
1. å®ç°ä¼šè¯åˆ—è¡¨
2. å®ç°ä¼šè¯åˆ‡æ¢
3. å®ç°å¯¼å‡ºåŠŸèƒ½

**é¢„è®¡æ—¶é—´**ï¼š2-3 å¤©

### 6.2 ä»£ç å®ç°å»ºè®®

#### æ¨èå®ç°æ–¹æ¡ˆ

```python
# src/agents/main_agent.py
from langgraph.checkpoint.sqlite import SqliteSaver
from pathlib import Path

async def create_hkex_agent(...):
    # ... ç°æœ‰ä»£ç  ...
    
    # åˆ›å»ºæŒä¹…åŒ– checkpointer
    agent_dir = Path.home() / ".hkex-agent" / assistant_id
    agent_dir.mkdir(parents=True, exist_ok=True)
    db_path = agent_dir / "checkpoints.db"
    
    # ä½¿ç”¨ SqliteSaver
    checkpointer = SqliteSaver.from_conn_string(f"sqlite:///{db_path}")
    
    # ... åˆ›å»º agent ...
    agent.checkpointer = checkpointer
    
    return agent
```

```python
# src/cli/commands.py
import time

def handle_command(command: str, agent, token_tracker: TokenTracker) -> str | bool:
    # ...
    if cmd == "clear":
        # æ–¹æ¡ˆï¼šä½¿ç”¨æ–°çš„ thread_idï¼Œä¿ç•™å†å²æ•°æ®
        # ä¸‹æ¬¡æ‰§è¡Œæ—¶ä¼šè‡ªåŠ¨ä½¿ç”¨æ–° thread
        # å†å²æ•°æ®ä¿ç•™åœ¨æ•°æ®åº“ä¸­ï¼Œå¯é€šè¿‡ /history æŸ¥çœ‹
        
        token_tracker.reset()
        # ... æ¸…å±ç­‰æ“ä½œ ...
        console.print("[dim]New conversation started. Use /history to view past conversations.[/dim]")
        return True
```

### 6.3 ç›‘æ§æŒ‡æ ‡å»ºè®®

#### å…³é”®æŒ‡æ ‡

```python
# å»ºè®®ç›‘æ§çš„æŒ‡æ ‡
metrics = {
    "database_size": "checkpoints.db æ–‡ä»¶å¤§å°",
    "conversation_count": "å¯¹è¯æ•°é‡",
    "average_conversation_length": "å¹³å‡å¯¹è¯é•¿åº¦",
    "restore_time": "çŠ¶æ€æ¢å¤æ—¶é—´",
    "checkpoint_write_time": "æ£€æŸ¥ç‚¹å†™å…¥æ—¶é—´",
}
```

### 6.4 æ•°æ®æ¸…ç†ç­–ç•¥

#### æ¨èæ¸…ç†æœºåˆ¶

```python
# å®ç°è‡ªåŠ¨æ¸…ç†ï¼ˆå¯é€‰ï¼‰
def cleanup_old_conversations(checkpointer, days=30):
    """æ¸…ç†æŒ‡å®šå¤©æ•°å‰çš„å¯¹è¯è®°å½•"""
    # 1. åˆ—å‡ºæ‰€æœ‰ thread
    # 2. æ£€æŸ¥æ¯ä¸ª thread çš„æœ€åæ›´æ–°æ—¶é—´
    # 3. åˆ é™¤è¶…è¿‡æŒ‡å®šå¤©æ•°çš„ thread
    pass

# æˆ–æä¾›æ‰‹åŠ¨æ¸…ç†å‘½ä»¤
# /cleanup [days=30]  # æ¸…ç† N å¤©å‰çš„å¯¹è¯
```

---

## 7. ç»¼åˆè¯„ä¼°ç»“è®º ğŸ“Š

### 7.1 è¯„ä¼°çŸ©é˜µ

| è¯„ä¼°ç»´åº¦ | è¯„åˆ† | æƒé‡ | åŠ æƒåˆ† | è¯´æ˜ |
|---------|------|------|--------|------|
| **æŠ€æœ¯å¯è¡Œæ€§** | 9/10 | 20% | 1.8 | æŠ€æœ¯æˆç†Ÿï¼Œå®ç°ç®€å• |
| **æ€§èƒ½å½±å“** | 8/10 | 15% | 1.2 | å•ç”¨æˆ·åœºæ™¯å½±å“å¯å¿½ç•¥ |
| **ç”¨æˆ·ä½“éªŒ** | 10/10 | 25% | 2.5 | æ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒ |
| **å®ç°å¤æ‚åº¦** | 8/10 | 15% | 1.2 | å·¥ä½œé‡å°ï¼Œå¤æ‚åº¦ä½ |
| **é£é™©æ§åˆ¶** | 8/10 | 15% | 1.2 | é£é™©ä½ï¼Œå¯æ§ |
| **æŠ•èµ„å›æŠ¥** | 10/10 | 10% | 1.0 | æŠ•å…¥å°ï¼Œæ”¶ç›Šå¤§ |

**ç»¼åˆè¯„åˆ†**ï¼š**8.9/10** â­â­â­â­â­

### 7.2 æœ€ç»ˆå»ºè®®

#### âœ… **å¼ºçƒˆæ¨èå®æ–½**

**ç†ç”±**ï¼š
1. âœ… **æŠ€æœ¯æˆç†Ÿ**ï¼šSqliteSaver æ˜¯å®˜æ–¹æ¨èæ–¹æ¡ˆ
2. âœ… **å®ç°ç®€å•**ï¼šä»£ç å˜æ›´é‡å°ï¼ˆ<100 è¡Œï¼‰
3. âœ… **é£é™©å¯æ§**ï¼šä½é£é™©ï¼Œå½±å“èŒƒå›´å°
4. âœ… **æ”¶ç›Šæ˜ç¡®**ï¼šæ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒ
5. âœ… **æŠ•èµ„å›æŠ¥é«˜**ï¼šæŠ•å…¥ 2-3 å¤©ï¼Œæ”¶ç›Šé•¿æœŸ

#### ğŸ“‹ **å®æ–½å»ºè®®**

1. **ç«‹å³å®æ–½**ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆé˜¶æ®µ 1ï¼‰
2. **åç»­ä¼˜åŒ–**ï¼šå†å²æŸ¥çœ‹åŠŸèƒ½ï¼ˆé˜¶æ®µ 2ï¼‰
3. **å¯é€‰æ‰©å±•**ï¼šå¤šä¼šè¯ç®¡ç†ï¼ˆé˜¶æ®µ 3ï¼‰

#### âš ï¸ **æ³¨æ„äº‹é¡¹**

1. **æ•°æ®éšç§**ï¼šæ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·æ•°æ®å­˜å‚¨ä½ç½®
2. **æ¸…ç†æœºåˆ¶**ï¼šå®ç°å®šæœŸæ¸…ç†ï¼Œé¿å…æ•°æ®åº“è¿‡å¤§
3. **å¤‡ä»½ç­–ç•¥**ï¼šé‡è¦å¯¹è¯å»ºè®®å®šæœŸå¤‡ä»½
4. **æµ‹è¯•å……åˆ†**ï¼šç¡®ä¿ä¸å½±å“ç°æœ‰åŠŸèƒ½

---

## 8. é™„å½• ğŸ“

### 8.1 å‚è€ƒèµ„æº

- [LangGraph Checkpointing æ–‡æ¡£](https://langchain-ai.github.io/langgraph/concepts/persistence/)
- [SqliteSaver API æ–‡æ¡£](https://github.com/langchain-ai/langgraph/tree/main/libs/langgraph-checkpoint-sqlite)
- [DeepAgents æ¡†æ¶æ–‡æ¡£](https://docs.langchain.com/oss/python/deepagents/overview)

### 8.2 å®æ–½æ£€æŸ¥æ¸…å•

- [ ] å®‰è£… `langgraph-checkpoint-sqlite` ä¾èµ–
- [ ] ä¿®æ”¹ `main_agent.py` ä½¿ç”¨ SqliteSaver
- [ ] æ”¹è¿› `/clear` å‘½ä»¤
- [ ] æ·»åŠ  `/history` å‘½ä»¤ï¼ˆå¯é€‰ï¼‰
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] ç¼–å†™é›†æˆæµ‹è¯•
- [ ] æ›´æ–°ç”¨æˆ·æ–‡æ¡£
- [ ] å®ç°æ¸…ç†æœºåˆ¶ï¼ˆå¯é€‰ï¼‰
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] ç”¨æˆ·éªŒæ”¶æµ‹è¯•

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2025-01-XX  
**è¯„ä¼°ç‰ˆæœ¬**ï¼šv1.0  
**è¯„ä¼°è€…**ï¼šAI å¤šä¸“å®¶å…±è¯†ç³»ç»Ÿ

